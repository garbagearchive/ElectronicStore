<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Account Access</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body {
            background-color: #f8f9fa; /* Màu nền nhạt */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            /* Tùy chọn: Thêm ảnh nền nếu muốn */
            /* background: url('your-background-image.jpg') no-repeat center center fixed;
             background-size: cover; */
        }

        .form-container {
            background-color: #ffffff;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            max-width: 450px;
            width: 100%;
        }

            .form-container .nav-tabs .nav-link {
                border: none;
                border-bottom: 2px solid transparent;
                color: #6c757d;
            }

                .form-container .nav-tabs .nav-link.active {
                    border-bottom-color: #0d6efd;
                    color: #0d6efd;
                    font-weight: bold;
                }

            .form-container h2 {
                text-align: center;
                margin-bottom: 15px;
                color: #333;
            }

            .form-container .btn-google {
                background-color: #db4437;
                color: white;
                width: 100%;
                margin-bottom: 15px;
            }

                .form-container .btn-google:hover {
                    background-color: #c33d2e;
                }

            .form-container .or-separator {
                text-align: center;
                margin: 15px 0;
                color: #6c757d;
                position: relative;
            }

                .form-container .or-separator::before,
                .form-container .or-separator::after {
                    content: "";
                    display: block;
                    width: 40%;
                    height: 1px;
                    background: #dee2e6;
                    position: absolute;
                    top: 50%;
                }

                .form-container .or-separator::before {
                    left: 0;
                }

                .form-container .or-separator::after {
                    right: 0;
                }

            .form-container .form-label {
                font-weight: 500;
            }

            .form-container .form-control {
                border-radius: 5px;
            }

            .form-container .btn-primary {
                background-color: #0d6efd;
                border: none;
                width: 100%;
                padding: 10px;
            }

            .form-container .forgot-password {
                display: block;
                text-align: right;
                margin-top: -10px;
                margin-bottom: 15px;
                font-size: 0.9em;
            }

        .alert {
            margin-top: 15px;
        }
        /* Dành cho thông báo lỗi/thành công */

    </style>
</head>
<body>

    <div class="form-container">
        <ul class="nav nav-tabs nav-fill mb-4" id="accountTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="login-tab" data-bs-toggle="tab" data-bs-target="#login-tab-pane" type="button" role="tab" aria-controls="login-tab-pane" aria-selected="true">Login</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="register-tab" data-bs-toggle="tab" data-bs-target="#register-tab-pane" type="button" role="tab" aria-controls="register-tab-pane" aria-selected="false">Register</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="change-password-tab" data-bs-toggle="tab" data-bs-target="#change-password-tab-pane" type="button" role="tab" aria-controls="change-password-tab-pane" aria-selected="false">Change Password</button>
            </li>
        </ul>

        <div class="tab-content" id="accountTabContent">

            <div class="tab-pane fade show active" id="login-tab-pane" role="tabpanel" aria-labelledby="login-tab" tabindex="0">
                <h2>Login Account</h2>
                <div id="login-message" class="alert d-none"></div> <form id="loginForm">
                    <div class="mb-3">
                        <label for="loginUsername" class="form-label">Username or Email <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="loginUsername" placeholder="Enter username or email" required>
                    </div>
                    <div class="mb-3">
                        <label for="loginPassword" class="form-label">Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="loginPassword" placeholder="Enter password" required>
                    </div>
                    <a href="#" class="forgot-password" onclick="showChangePasswordTab()">Lost Password?</a>
                    <button type="submit" class="btn btn-primary">Submit</button>
                </form>
            </div>

            <div class="tab-pane fade" id="register-tab-pane" role="tabpanel" aria-labelledby="register-tab" tabindex="0">
                <h2>Register Account</h2>
                <div id="register-message" class="alert d-none"></div> <form id="registerForm">
                    <div class="mb-3">
                        <label for="registerUsername" class="form-label">Username <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="registerUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerPassword" class="form-label">Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="registerPassword" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerFullname" class="form-label">Full Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="registerFullname" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerEmail" class="form-label">Email <span class="text-danger">*</span></label>
                        <input type="email" class="form-control" id="registerEmail" required>
                    </div>
                    <div class="mb-3">
                        <label for="registerPhone" class="form-label">Phone</label>
                        <input type="tel" class="form-control" id="registerPhone">
                    </div>
                    <div class="mb-3">
                        <label for="registerAddress" class="form-label">Address</label>
                        <input type="text" class="form-control" id="registerAddress">
                    </div>
                    <button type="submit" class="btn btn-primary">Register</button>
                </form>
            </div>

            <div class="tab-pane fade" id="change-password-tab-pane" role="tabpanel" aria-labelledby="change-password-tab" tabindex="0">
                <h2>Change Password</h2>
                <div id="change-password-message" class="alert d-none"></div>
                <form id="changePasswordForm">
                    <div class="mb-3">
                        <label for="changePassUsername" class="form-label">Username <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="changePassUsername" placeholder="Enter your Username" required>
                        <small class="form-text text-muted">Enter the username of the user whose password you want to change.</small>
                    </div>
                    <div class="mb-3">
                        <label for="changePassOld" class="form-label">Old Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="changePassOld" required>
                    </div>
                    <div class="mb-3">
                        <label for="changePassNew" class="form-label">New Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="changePassNew" required>
                    </div>
                    <div class="mb-3">
                        <label for="changePassConfirm" class="form-label">Confirm New Password <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="changePassConfirm" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Update Password</button>
                </form>
            </div>

        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:5160/api/account'; // Điều chỉnh nếu base route của bạn khác

        // ----- Helper Functions -----
        function showMessage(tabId, message, type = 'danger') {
            const messageDiv = $(`#${tabId}-message`);
            messageDiv.removeClass('d-none alert-danger alert-success alert-warning').addClass(`alert-${type}`).text(message);
        }

        function hideMessages() {
            $('.alert').addClass('d-none').text('');
        }

        function showChangePasswordTab() {
            // Sử dụng Bootstrap 5 API để kích hoạt tab
            const changePasswordTab = new bootstrap.Tab(document.getElementById('change-password-tab'));
            changePasswordTab.show();
        }

        // ----- MAIN LOGIC -----
        $(document).ready(function () {

            $('#loginForm').on('submit', async function (e) {
                e.preventDefault();
                hideMessages();

                const username = $('#loginUsername').val().trim();
                const password = $('#loginPassword').val().trim();

                if (!username || !password) {
                    showMessage('login', 'Please enter both username/email and password.');
                    return;
                }

                // *** ĐOẠN NÀY KIỂM TRA TÀI KHOẢN ADMIN CỨNG ***
                if (username === "AdminMaster" && password === "123456789") {
                    localStorage.setItem('authToken', 'special-admin-token'); // Có thể dùng token giả nếu cần
                    localStorage.setItem('userRole', 'admin');
                    window.location.href = 'admin.html';
                    return;
                }

                // API Login dùng [FromQuery] nên gửi qua URL
                const loginUrl = `${API_BASE_URL}/Login?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`;

                try {
                    const response = await fetch(loginUrl, { method: 'POST' });

                    if (response.ok) {
                        const data = await response.json();
                        console.log("Login Success:", data);

                        // Lấy token và role từ response
                        const token = data.Token || data.token;
                        // Gọi API để lấy thông tin user (bao gồm role)
                        const userInfoUrl = `${API_BASE_URL}/List`;
                        const userInfoResponse = await fetch(userInfoUrl, {
                            method: 'GET',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });

                        if (userInfoResponse.ok) {
                            const userInfo = await userInfoResponse.json();
                            const userRole = userInfo.role || 'Buyer'; // Mặc định là Buyer nếu không có role

                            localStorage.setItem('authToken', token);
                            localStorage.setItem('userRole', userRole);
                            showMessage('login', 'Login successful! Redirecting...', 'success');

                            // Redirect based on role
                            if (userRole.toLowerCase() === 'admin') {
                                window.location.href = 'admin.html';
                            } else {
                                window.location.href = 'buyer.html';
                            }
                        } else {
                            console.error("Failed to get user info:", await userInfoResponse.text());
                            showMessage('login', 'Login successful but failed to get user role.');
                        }
                    } else if (response.status === 401) {
                        showMessage('login', 'Invalid username or password.');
                        $('#loginPassword').val(''); // Clear password field
                    } else {
                        const errorText = await response.text();
                        console.error("Login Error:", response.status, errorText);
                        showMessage('login', `Login failed. Status: ${response.status}`);
                    }
                } catch (error) {
                    console.error("Login Fetch Error:", error);
                    showMessage('login', 'An error occurred during login. Please check your connection.');
                }
            });

            // --- Register Form Submission ---
            $('#registerForm').on('submit', async function (e) {
                e.preventDefault();
                hideMessages();

                const requestBody = {
                    username: $('#registerUsername').val().trim(),
                    password: $('#registerPassword').val(), // Không trim password
                    fullName: $('#registerFullname').val().trim(),
                    email: $('#registerEmail').val().trim(),
                    phone: $('#registerPhone').val().trim(),
                    address: $('#registerAddress').val().trim(),
                    role: 'Buyer' // Luôn đặt role là Buyer khi đăng ký
                };

                // Validate required fields (basic)
                if (!requestBody.username || !requestBody.password || !requestBody.fullName || !requestBody.email) {
                    showMessage('register', 'Please fill in all required fields (*).');
                    return;
                }

                const registerUrl = `${API_BASE_URL}/Register`;

                try {
                    const response = await fetch(registerUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });

                    if (response.ok) {
                        const data = await response.json();
                        showMessage('register', 'Đăng ký thành công!', 'success');
                        $('#registerForm')[0].reset(); // Reset form

                        // Tự động chuyển sang tab login sau 2 giây
                        setTimeout(() => {
                            const loginTab = new bootstrap.Tab(document.getElementById('login-tab'));
                            loginTab.show();
                        }, 2000);
                    } else if (response.status === 409) { // Conflict
                        showMessage('register', 'Username already exists. Please choose another.');
                    } else {
                        let errorMsg = `Registration failed. Status: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorMsg = `Registration failed: ${errorData.title || errorData.message || errorData || 'Invalid data.'}`;
                        } catch (jsonError) { /* Ignore if response is not json */ }
                        console.error("Register Error:", response.status, await response.text());
                        showMessage('register', errorMsg);
                    }
                } catch (error) {
                    console.error("Register Fetch Error:", error);
                    showMessage('register', 'An error occurred during registration. Please check your connection.');
                }
            });

            // --- Change Password Form Submission ---
            $('#changePasswordForm').on('submit', async function (e) {
                e.preventDefault();
                hideMessages();

                const username = $('#changePassUsername').val().trim(); // Changed from UserId
                const oldPassword = $('#changePassOld').val();
                const newPassword = $('#changePassNew').val();
                const confirmNewPassword = $('#changePassConfirm').val();

                if (!username) { // Changed from UserId
                    showMessage('change-password', 'Please enter a valid Username.');
                    return;
                }
                if (!oldPassword || !newPassword || !confirmNewPassword) {
                    showMessage('change-password', 'Please fill in all password fields.');
                    return;
                }
                if (newPassword !== confirmNewPassword) {
                    showMessage('change-password', 'New password and confirmation do not match.');
                    return;
                }
                // Thêm validation độ dài newPassword nếu cần

                const requestBody = {
                    username: username, // Changed from UserId
                    oldPassword: oldPassword,
                    newPassword: newPassword,
                    confirmNewPassword: confirmNewPassword
                };
                const changePasswordUrl = `${API_BASE_URL}/change-password`;

                try {
                    const response = await fetch(changePasswordUrl, {
                        method: 'PUT', // Sử dụng PUT cho update
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody)
                    });
                    // Backend trả về 200 OK kèm message hoặc 204 No Content
                    if (response.ok) {
                        let successMsg = 'Password changed successfully!';
                        try {
                            // Thử đọc message từ response nếu có (backend trả về 200 OK)
                            const data = await response.json();
                            successMsg = data.message || successMsg;
                        } catch (e) {
                            // Bỏ qua nếu response là 204 No Content hoặc không phải JSON
                        }
                        showMessage('change-password', successMsg, 'success');
                        $('#changePasswordForm')[0].reset(); // Reset form
                    } else {
                        let errorMsg = `Password change failed. Status: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            // Đọc lỗi từ backend
                            errorMsg = `Password change failed: ${errorData.message || 'Check input data.'}`;
                        } catch (jsonError) { /* Ignore if response is not json */ }
                        console.error("Change Password Error:", response.status, await response.text());
                        showMessage('change-password', errorMsg);
                    }
                } catch (error) {
                    console.error("Change Password Fetch Error:", error);
                    showMessage('change-password', 'An error occurred. Please check your connection.');
                }
            });

        }); // End document.ready
    </script>

</body>
</html>
